-- database: ../AJDataBase/EXOTROOPER.sqlite
/*
Autor: Josue Astudillo
Fecha: 28.enero.2026
Script: Creacion de la estructura de datos para Exobot
*/


DROP TABLE IF EXISTS Usuario;
DROP VIEW  IF EXISTS ExobotDetalle;    /*Refactorizacion*/
DROP TABLE IF EXISTS Exobot;
DROP TABLE IF EXISTS Arma;           /*Refactorizacion*/
DROP TABLE IF EXISTS TipoExobot;


CREATE TABLE Usuario (
    IdUsuario      INTEGER      NOT NULL PRIMARY KEY AUTOINCREMENT,
    Cedula         VARCHAR(10)  NOT NULL UNIQUE,
    Nombre         VARCHAR(100) NOT NULL
);
CREATE TABLE TipoExobot (
    IdTipoExobot    INTEGER PRIMARY KEY AUTOINCREMENT,
    Nombre          VARCHAR(30) NOT NULL UNIQUE,

    Estado          VARCHAR(1) NOT NULL DEFAULT 'A',
    FechaCreacion   DATETIME DEFAULT (datetime('now','localtime')),
    FechaModifica   DATETIME DEFAULT (datetime('now','localtime'))
);

CREATE TABLE Arma (
    IdArma      INTEGER PRIMARY KEY AUTOINCREMENT,
    Tipo        VARCHAR(30) NOT NULL,
    Accion      VARCHAR(50) NOT NULL,
    Entrenada   INTEGER DEFAULT 0, -- 0 = NO, 1 = SI

    Estado          VARCHAR(1) NOT NULL DEFAULT 'A',
    FechaCreacion   DATETIME DEFAULT (datetime('now','localtime')),
    FechaModifica   DATETIME DEFAULT (datetime('now','localtime'))
);

CREATE TABLE Exobot (
     IdExobot        INTEGER PRIMARY KEY AUTOINCREMENT,
    IdTipoExobot    INTEGER NOT NULL,
    IdArmaDerecha   INTEGER,
    IdArmaIzquierda INTEGER,

    Serie           VARCHAR(30) NOT NULL UNIQUE,
    Nombre          VARCHAR(30) NOT NULL,

    Entreno         VARCHAR(2) DEFAULT 'NO', -- SI / NO
    NoAccion        INTEGER DEFAULT 0,

    Estado          VARCHAR(1) NOT NULL DEFAULT 'A',
    FechaCreacion   DATETIME DEFAULT (datetime('now','localtime')),
    FechaModifica   DATETIME DEFAULT (datetime('now','localtime')),

    FOREIGN KEY (IdTipoExobot)    REFERENCES MS_TipoExobot(IdTipoExobot),
    FOREIGN KEY (IdArmaDerecha)   REFERENCES MS_Arma(IdArma),
    FOREIGN KEY (IdArmaIzquierda) REFERENCES MS_Arma(IdArma)
);




-- ==========================================
-- DATOS DE PRUEBA 
-- ==========================================


INSERT INTO Usuario (Cedula, Nombre) VALUES 
('1726543210', 'Patricio Michael Paccha'),
('1751455096', 'Josue Sebastian Astudillo'),
('1723896541', 'Ana Maria Lopez');

INSERT INTO TipoExobot (Nombre)
VALUES ('Infantería'), ('Defensa'), ('Explorador');

INSERT INTO Arma (Tipo, Accion, Entrenada)
VALUES
('Misil', 'Disparar', 0),
('Mortero', 'Disparar', 0);

INSERT INTO Exobot
(IdTipoExobot, IdArmaDerecha, IdArmaIzquierda, Serie, Nombre)
VALUES
(1, 1, 2, 'INF-001', 'ExoTrooper'),
(2, 2, 1, 'EXP-001', 'ExoScout');

CREATE VIEW ExobotDetalle AS
SELECT
    e.IdExobot,
    e.Nombre,
    e.Serie,
    t.Nombre AS TipoExobot,
    e.Entreno,
    e.NoAccion,
    ad.Tipo AS ArmaDerecha,
    ai.Tipo AS ArmaIzquierda
FROM Exobot e
JOIN TipoExobot t ON e.IdTipoExobot = t.IdTipoExobot
LEFT JOIN Arma ad ON e.IdArmaDerecha = ad.IdArma
LEFT JOIN Arma ai ON e.IdArmaIzquierda = ai.IdArma
WHERE e.Estado = 'A';


-- Verificación final
SELECT * FROM Usuario;
